(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();const h={};function ve(e,t,n,o){h[e]&&(h[e].remove(),delete h[e]);const r=document.getElementById(e);if(!r){console.error(`Elemen kontainer peta dengan ID ${e} tidak ditemukan.`);return}r.style.display="block",r.style.height="300px";const a=L.map(e).setView([t,n],13);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(a),L.marker([t,n]).addTo(a).bindPopup(`<b>${o}</b><br>Lokasi cerita ini.`).openPopup(),h[e]=a,setTimeout(()=>{h[e]&&h[e].invalidateSize()},100)}const Ee=e=>{const t=e.photoUrl||"https://via.placeholder.com/300x200?text=No+Image",n=e.name||"Judul Tidak Tersedia",o=e.description||"Deskripsi tidak tersedia.",r=e.createdAt?new Date(e.createdAt).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"}):"Tanggal tidak tersedia",a=`Gambar cerita dari ${n}`,i=e.id||`story-item-${Math.random().toString(36).substring(2,9)}`;let l="";if(e.lat!==void 0&&e.lon!==void 0&&e.lat!==null&&e.lon!==null){const s=`map-container-${i}`;l=`
      <div class="story-item__location-controls">
        <button class="button button--secondary view-map-button" 
                data-lat="${e.lat}" 
                data-lon="${e.lon}" 
                data-story-name="${n}" 
                data-map-target="${s}">
          Lihat Lokasi di Peta
        </button>
        <div id="${s}" class="story-item__map-container" style="display: none; height: 0px; margin-top: 10px;">
          </div>
      </div>
    `}return`
    <article class="story-item" id="story-${i}">
      <img src="${t}" alt="${a}" class="story-item__image" loading="lazy">
      <div class="story-item__content">
        <h3 class="story-item__title">${n}</h3>
        <p class="story-item__description">${o}</p>
        <p class="story-item__date">Dibuat pada: ${r}</p>
        ${l}
      </div>
    </article>
  `},Pe=(e,t=[])=>{if(!e){console.error("Elemen kontainer tidak disediakan untuk renderHome");return}e.innerHTML=`
    <div class="page-header">
      <h1>Daftar Cerita</h1>
      <p>Berikut adalah cerita-cerita yang telah dibagikan.</p>
    </div>
    <div id="story-list-container" class="story-list">
      ${t.length>0?t.map(Ee).join(""):'<p class="no-stories">Belum ada cerita untuk ditampilkan saat ini. Silakan coba lagi nanti atau tambahkan cerita baru!</p>'}
    </div>
  `,Le()};function Le(){document.querySelectorAll(".view-map-button").forEach(t=>{t.addEventListener("click",n=>{const o=n.currentTarget,r=parseFloat(o.dataset.lat),a=parseFloat(o.dataset.lon),i=o.dataset.storyName,l=o.dataset.mapTarget,s=document.getElementById(l);if(s){const c=s.style.display==="none"||s.style.height==="0px";document.querySelectorAll(".story-item__map-container").forEach(p=>{if(p.id!==l){p.style.display="none",p.style.height="0px",h[p.id]&&(h[p.id].remove(),delete h[p.id]);const f=document.querySelector(`.view-map-button[data-map-target="${p.id}"]`);f&&(f.textContent="Lihat Lokasi di Peta")}}),c?(ve(l,r,a,i),o.textContent="Sembunyikan Peta"):(s.style.display="none",s.style.height="0px",h[l]&&(h[l].remove(),delete h[l]),o.textContent="Lihat Lokasi di Peta")}})})}const Se=e=>{if(!e){console.error("Elemen kontainer tidak disediakan untuk showLoading");return}e.innerHTML=`
    <div class="page-header">
      <h1>Daftar Cerita</h1>
    </div>
    <div class="loading-indicator">
      <p>Memuat cerita, mohon tunggu...</p>
      <div class="spinner" aria-hidden="true"></div>
    </div>
  `},xe=(e,t)=>{if(!e){console.error("Elemen kontainer tidak disediakan untuk showError");return}e.innerHTML=`
    <div class="page-header">
      <h1>Daftar Cerita</h1>
    </div>
    <div class="error-message">
      <h2>Oops! Terjadi Kesalahan</h2>
      <p>${t}</p>
      <button id="retry-load-stories" class="button button--primary">Coba Lagi</button>
    </div>
  `;const n=e.querySelector("#retry-load-stories");n&&n.addEventListener("click",o=>{o.preventDefault(),window.dispatchEvent(new HashChangeEvent("hashchange"))})};let x=null,E=null,g=null,M=null;const P=()=>{if(x){x.getTracks().forEach(t=>t.stop()),x=null;const e=document.getElementById("camera-video");e&&(e.srcObject=null),console.log("View: Camera stream stopped.")}};window.stopActiveCameraStreamGlobal=P;const U=()=>{g&&(g.remove(),g=null,M=null,console.log("View: Location picker map destroyed."))};window.destroyActiveLocationPickerMapGlobal=U;const Ie=e=>{P(),U(),E=null,e.innerHTML=`
    <div class="page-header">
      <h1>Tambah Cerita Baru</h1>
      <p>Bagikan momen berharga Anda melalui cerita dan foto.</p>
    </div>
    <form id="add-story-form" class="add-story-form">
      <div class="form-group">
        <label for="story-description">Deskripsi Cerita:</label>
        <textarea id="story-description" name="description" rows="4" required></textarea>
      </div>

      <div class="form-group">
        <label>Foto Cerita:</label>
        <div id="camera-controls" style="margin-bottom: 10px;">
            <button type="button" id="use-camera-button" class="button button--secondary">Gunakan Kamera</button>
            <span style="margin: 0 10px;">atau</span>
            <label for="story-photo" class="button button--secondary" style="cursor:pointer; display:inline-block;">Pilih File</label>
            <input type="file" id="story-photo" name="photo" accept="image/*" style="display:none;">
        </div>

        <div id="camera-area" style="margin-bottom: 10px; display:none;">
          <video id="camera-video" playsinline autoplay style="width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 4px; background-color: #000;"></video>
          <canvas id="camera-canvas" style="display:none;"></canvas> <div style="margin-top:10px;">
              <button type="button" id="capture-photo-button" class="button button--primary">Ambil Foto</button>
              <button type="button" id="close-camera-button" class="button button--danger" style="margin-left:5px;">Tutup Kamera</button>
          </div>
        </div>
        
        <img id="image-preview" src="#" alt="Pratinjau gambar yang akan diunggah atau diambil" style="display: none; max-width: 100%; margin-top: 10px; max-height: 300px; border: 1px solid #ccc; border-radius: 4px;"/>
        <input type="hidden" id="photo-source" name="photoSource" value="file"> </div>

      <div class="form-group">
        <p><strong>Pengambilan Lokasi (Opsional):</strong></p>
        <button type="button" id="toggle-map-picker" class="button button--secondary">Ambil Lokasi dari Peta</button>
        <div id="map-picker-container" style="height: 350px; border: 1px solid var(--warna-border, #ccc); margin-top:10px; margin-bottom:10px; display:none; border-radius: 4px; position: relative; background-color: #e9e9e9;">
          </div>
        <label for="story-latitude" style="margin-top:5px; display:block;">Latitude:</label>
        <input type="text" id="story-latitude" name="latitude" placeholder="Contoh: -6.200000" readonly >
        <label for="story-longitude" style="margin-top:5px; display:block;">Longitude:</label>
        <input type="text" id="story-longitude" name="longitude" placeholder="Contoh: 106.816666" readonly >
      </div>
      
      <div class="form-actions">
        <button type="submit" id="submit-story-button" class="button button--primary">Publikasikan Cerita</button>
        <div id="loading-indicator-add" style="display: none; margin-right:10px; font-style:italic;">Mengirim cerita...</div>
        <div id="error-message-add" class="error-message-form" style="display: none;"></div>
      </div>
    </form>
  `;const t=e.querySelector("#story-photo"),n=e.querySelector("#image-preview"),o=e.querySelector("#photo-source"),r=e.querySelector("#camera-controls"),a=e.querySelector("#camera-area"),i=e.querySelector("#camera-video"),l=e.querySelector("#camera-canvas"),s=e.querySelector("#use-camera-button"),c=e.querySelector("#capture-photo-button"),p=e.querySelector("#close-camera-button"),f=e.querySelector("#toggle-map-picker"),d=e.querySelector("#map-picker-container"),u=e.querySelector("#story-latitude"),w=e.querySelector("#story-longitude"),I=m=>{n&&(n.src=m,n.style.display="block")};t&&t.addEventListener("change",()=>{console.log("View: File input changed."),P(),a&&(a.style.display="none"),r&&(r.style.display="block");const m=t.files[0];if(m){const y=new FileReader;y.onload=T=>I(T.target.result),y.readAsDataURL(m),o&&(o.value="file"),E=null}else n&&(n.src="#",n.style.display="none")}),s&&a&&i&&r&&o&&s.addEventListener("click",async()=>{console.log('View: "Gunakan Kamera" button clicked.'),P(),t&&(t.value=""),n&&(n.style.display="none"),E=null,a.style.display="block",r.style.display="none";try{x=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}),i.srcObject=x,o.value="camera",console.log("View: Camera stream started.")}catch(m){console.error("View: Error mengakses kamera: ",m),alert(`Tidak bisa mengakses kamera. Pastikan Anda memberikan izin dan kamera tersedia.
Error: `+m.message),a.style.display="none",r.style.display="block",o.value="file"}}),c&&i&&l&&n&&r&&o&&c.addEventListener("click",()=>{if(console.log('View: "Ambil Foto" button clicked.'),!x||!i.srcObject){alert("Kamera tidak aktif.");return}l.width=i.videoWidth,l.height=i.videoHeight,l.getContext("2d").drawImage(i,0,0,l.width,l.height);const y=l.toDataURL("image/jpeg",.9);I(y),l.toBlob(T=>{E=T,console.log("View: Photo captured as blob.")},"image/jpeg",.9),P(),a.style.display="none",r.style.display="block"}),p&&a&&r&&o&&n&&p.addEventListener("click",()=>{console.log('View: "Tutup Kamera" button clicked.'),P(),a.style.display="none",r.style.display="block",o.value==="camera"&&!E&&(o.value="file",n.style.display="none")});const N=()=>{if(g||!d)return;console.log("View: Initializing location picker map.");const m=-6.2088,y=106.8456,T=12;d.innerHTML="";try{g=L.map(d).setView([m,y],T),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(g);const B=L.DomUtil.create("div","map-info-overlay leaflet-control");B.innerHTML="Klik pada peta untuk memilih lokasi.",B.style.cssText="background: white; padding: 6px 10px; margin:10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; box-shadow: 0 1px 5px rgba(0,0,0,0.4);";const ye=L.Control.extend({onAdd:function(v){return B},onRemove:function(v){}});new ye({position:"topleft"}).addTo(g),g.on("click",v=>{const{lat:be,lng:we}=v.latlng;u&&(u.value=be.toFixed(6)),w&&(w.value=we.toFixed(6)),M?M.setLatLng(v.latlng):(M=L.marker(v.latlng,{draggable:!0}).addTo(g),M.on("dragend",ke=>{const ee=ke.target.getLatLng();u&&(u.value=ee.lat.toFixed(6)),w&&(w.value=ee.lng.toFixed(6))})),g.panTo(v.latlng)}),setTimeout(()=>{g&&g.invalidateSize()},100)}catch(B){console.error("View: Error initializing Leaflet map:",B),d.innerHTML="<p style='text-align:center; padding-top:20px; color:red;'>Gagal memuat peta. Pastikan Leaflet termuat dengan benar.</p>"}};f&&d&&f.addEventListener("click",()=>{console.log('View: "Toggle Map Picker" button clicked.'),d.style.display==="none"?(d.style.display="block",f.textContent="Sembunyikan Peta Lokasi",N()):(d.style.display="none",f.textContent="Ambil Lokasi dari Peta",U())}),e&&(e.getCapturedPhotoBlob=()=>E,e.getPhotoSource=()=>o?o.value:"file")},C=e=>{const t=document.getElementById("loading-indicator-add"),n=document.getElementById("submit-story-button");t&&n&&(t.style.display=e?"inline-block":"none",n.disabled=e)},j=e=>{const t=document.getElementById("error-message-add");t&&(t.textContent=e,t.style.display=e?"block":"none")},Te=e=>{e.innerHTML=`
      <div class="page-header" style="text-align: center;">
        <h1>Login ke Aplikasi Cerita</h1>
      </div>
      <div class="login-container" style="max-width: 400px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px;">
        <form id="login-form">
          <div class="form-group">
            <label for="login-email">Email:</label>
            <input type="email" id="login-email" name="email" required>
          </div>
          <div class="form-group">
            <label for="login-password">Password:</label>
            <input type="password" id="login-password" name="password" required autocomplete="current-password">
          </div>
          <div class="form-actions" style="text-align: center;">
            <button type="submit" id="login-button" class="button button--primary">Login</button>
            <div id="login-loading-indicator" style="display: none; margin-top:10px; font-style:italic;">Memproses login...</div>
            <div id="login-error-message" class="error-message-form" style="display: none; margin-top:10px;"></div>
          </div>
        </form>
        <p style="text-align:center; margin-top:15px;">Belum punya akun? <a href="#/register">Daftar di sini</a>.</p> 
        </div>
    `},Be=e=>{},te=e=>{},Ce=e=>{e.innerHTML=`
      <div class="page-header" style="text-align: center;">
        <h1>Buat Akun Baru</h1>
        <p>Daftarkan diri Anda untuk mulai berbagi cerita.</p>
      </div>
      <div class="register-container" style="max-width: 400px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px;">
        <form id="register-form">
          <div class="form-group">
            <label for="register-name">Nama Lengkap:</label>
            <input type="text" id="register-name" name="name" required>
          </div>
          <div class="form-group">
            <label for="register-email">Email:</label>
            <input type="email" id="register-email" name="email" required>
          </div>
          <div class="form-group">
            <label for="register-password">Password:</label>
            <input type="password" id="register-password" name="password" minlength="8" required>
            <small>Minimal 8 karakter.</small>
          </div>
          <div class="form-actions" style="text-align: center;">
            <button type="submit" id="register-button" class="button button--primary">Daftar</button>
            <div id="register-loading-indicator" style="display: none; margin-top:10px; font-style:italic;">Memproses pendaftaran...</div>
            <div id="register-error-message" class="error-message-form" style="display: none; margin-top:10px;"></div>
            <div id="register-success-message" style="display: none; margin-top:10px; color: green;"></div>
          </div>
        </form>
        <p style="text-align:center; margin-top:15px;">Sudah punya akun? <a href="#/login">Login di sini</a>.</p>
      </div>
    `},D=e=>{const t=document.getElementById("register-loading-indicator"),n=document.getElementById("register-button");t&&n&&(t.style.display=e?"block":"none",n.disabled=e)},A=e=>{const t=document.getElementById("register-error-message"),n=document.getElementById("register-success-message");t&&(t.textContent=e,t.style.display=e?"block":"none"),n&&(n.style.display="none")},ne=e=>{const t=document.getElementById("register-success-message"),n=document.getElementById("register-error-message");t&&(t.textContent=e,t.style.display=e?"block":"none"),n&&(n.style.display="none")},De=e=>{e.innerHTML=`
      <h1>404 - Halaman Tidak Ditemukan</h1>
      <p>Maaf, halaman yang Anda cari tidak tersedia.</p>
    `},$="https://story-api.dicoding.dev/v1";async function Q(e,t={}){const n=localStorage.getItem("userToken"),o={};t.body instanceof FormData||(o["Content-Type"]="application/json"),n&&(o.Authorization=`Bearer ${n}`);const r={...t,headers:{...o,...t.headers}};try{const a=await fetch(e,r);if(!a.ok){if(a.status===401||a.status===403)throw console.error("Authentication error:",a.status),localStorage.removeItem("userToken"),localStorage.removeItem("userName"),window.location.hash="#/login",new Error(`Unauthorized: ${a.statusText}. Redirecting to login.`);const i=await a.json().catch(()=>({message:a.statusText}));throw new Error(`HTTP error! status: ${a.status}, message: ${i.message||"Failed to fetch"}`)}return a.status===204?null:a.json()}catch(a){if(a.message.startsWith("Unauthorized:"))return console.warn(a.message),Promise.reject(a);throw console.error("Network/Fetch error in fetchWithAuth:",a),a}}async function Ae(e,t,n){try{const o=await fetch(`${$}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:n})}),r=await o.json();if(!o.ok||r.error)throw new Error(r.message||`HTTP error! status: ${o.status}`);return r}catch(o){throw console.error("Error registering user:",o),o}}async function Me(e,t){try{const n=await fetch(`${$}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),o=await n.json();if(!n.ok||o.error)throw new Error(o.message||`HTTP error! status: ${n.status}`);return o}catch(n){throw console.error("Error logging in user:",n),n}}async function _e(e=1,t=10,n=!1){let o=`${$}/stories?page=${e}&size=${t}`;n&&(o+="&location=1");const r=await Q(o);if(r&&!r.error)return r.listStory||[];if(r)throw new Error(r.message||"Failed to get stories");return[]}async function $e(e,t,n,o){const r=new FormData;r.append("description",e),r.append("photo",t),n!=null&&n!==""&&r.append("lat",parseFloat(n)),o!=null&&o!==""&&r.append("lon",parseFloat(o));const a=await Q(`${$}/stories`,{method:"POST",body:r});if(a&&!a.error)return a;throw a?new Error(a.message||"Gagal menambahkan cerita baru."):new Error("Gagal menambahkan cerita karena masalah otentikasi atau jaringan.")}async function Ne(e){const t=e.toJSON(),n={endpoint:t.endpoint,keys:{p256dh:t.keys.p256dh,auth:t.keys.auth}};try{const o=await Q(`${$}/notifications/subscribe`,{method:"POST",body:JSON.stringify(n)});return console.log("Respons dari server setelah subscribe notifikasi:",o),o}catch(o){throw console.error("Gagal mengirim subscription ke server:",o),o}}class je{constructor(t){this._appContentElement=t,this._handleAddNewStory=this._handleAddNewStory.bind(this),this._handleLogin=this._handleLogin.bind(this),this._handleRegister=this._handleRegister.bind(this)}_cleanupPreviousResources(){typeof window.stopActiveCameraStreamGlobal=="function"&&(console.log("PagePresenter: Cleaning up camera stream."),window.stopActiveCameraStreamGlobal()),typeof window.destroyActiveLocationPickerMapGlobal=="function"&&(console.log("PagePresenter: Cleaning up location picker map."),window.destroyActiveLocationPickerMapGlobal())}async showHomePage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}this._cleanupPreviousResources(),Se(this._appContentElement);try{if(!localStorage.getItem("userToken")){console.warn("PagePresenter (showHomePage): No user token found, should be redirected by router."),window.location.hash="#/login";return}const t=await _e();Pe(this._appContentElement,t)}catch(t){t&&t.message&&!t.message.startsWith("Unauthorized:")&&(console.error("PagePresenter: Gagal menampilkan halaman beranda:",t),xe(this._appContentElement,t.message||"Gagal memuat cerita."))}}showAddStoryPage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}if(!localStorage.getItem("userToken")){console.warn("PagePresenter (showAddStoryPage): No user token found, should be redirected by router."),window.location.hash="#/login";return}this._cleanupPreviousResources(),Ie(this._appContentElement);const t=this._appContentElement.querySelector("#add-story-form");t?(t.removeEventListener("submit",this._handleAddNewStory),t.addEventListener("submit",this._handleAddNewStory)):console.error("PagePresenter: Form #add-story-form tidak ditemukan setelah render.")}async _handleAddNewStory(t){t.preventDefault(),C(!0),j("");const n=t.target,o=n.elements.description,r=n.elements.photo,a=this._appContentElement.getPhotoSource?this._appContentElement.getPhotoSource():"file",i=this._appContentElement.getCapturedPhotoBlob?this._appContentElement.getCapturedPhotoBlob():null,l=n.elements.latitude,s=n.elements.longitude;if(!o){j("Kesalahan formulir: field deskripsi tidak ditemukan."),C(!1);return}const c=o.value.trim(),p=l?l.value.trim():"",f=s?s.value.trim():"";let d=null;if(a==="camera"&&i){const u=`camera-shot-${Date.now()}.jpg`;d=new File([i],u,{type:i.type||"image/jpeg"})}else r&&r.files&&r.files[0]&&(d=r.files[0]);if(!c||!d){j("Deskripsi dan foto wajib diisi."),C(!1);return}try{const u=await $e(c,d,p||void 0,f||void 0);C(!1),alert(`Cerita berhasil ditambahkan! Pesan: ${u.message}`),n.reset();const w=n.querySelector("#image-preview");w&&(w.style.display="none",w.src="#"),document.getElementById("story-latitude")&&(document.getElementById("story-latitude").value=""),document.getElementById("story-longitude")&&(document.getElementById("story-longitude").value="");const I=n.querySelector("#camera-area");I&&(I.style.display="none");const N=n.querySelector("#camera-controls");N&&(N.style.display="block");const m=n.querySelector("#map-picker-container");m&&(m.style.display="none");const y=n.querySelector("#toggle-map-picker");y&&(y.textContent="Ambil Lokasi dari Peta"),this._cleanupPreviousResources(),window.location.hash="#/"}catch(u){C(!1),u&&u.message&&!u.message.startsWith("Unauthorized:")&&j(u.message||"Gagal menambahkan cerita.")}}showLoginPage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}this._cleanupPreviousResources(),Te(this._appContentElement);const t=this._appContentElement.querySelector("#login-form");t?(t.removeEventListener("submit",this._handleLogin),t.addEventListener("submit",this._handleLogin)):console.error("PagePresenter: Form #login-form tidak ditemukan setelah render.")}async _handleLogin(t){t.preventDefault();const n=t.target,o=n.elements.email.value.trim(),r=n.elements.password.value;if(!(!o||!r))try{const a=await Me(o,r);Be(!1),!a.error&&a.loginResult&&a.loginResult.token?(localStorage.setItem("userToken",a.loginResult.token),localStorage.setItem("userName",a.loginResult.name),alert("Login berhasil!"),window.location.hash="#/"):te(a.message||"Login gagal. Periksa kredensial Anda.")}catch(a){te(a.message||"Terjadi kesalahan saat login.")}}showRegisterPage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}this._cleanupPreviousResources(),Ce(this._appContentElement);const t=this._appContentElement.querySelector("#register-form");t?(t.removeEventListener("submit",this._handleRegister),t.addEventListener("submit",this._handleRegister)):console.error("PagePresenter: Form #register-form tidak ditemukan setelah render.")}async _handleRegister(t){t.preventDefault(),D(!0),A(""),ne("");const n=t.target,o=n.elements.name.value.trim(),r=n.elements.email.value.trim(),a=n.elements.password.value;if(!o||!r||!a){A("Semua field wajib diisi."),D(!1);return}if(a.length<8){A("Password minimal 8 karakter."),D(!1);return}try{const i=await Ae(o,r,a);D(!1),i.error?A(i.message||"Pendaftaran gagal."):(ne(i.message+" Silakan login."),n.reset(),setTimeout(()=>{window.location.hash==="#/register"&&!localStorage.getItem("userToken")&&(window.location.hash="#/login")},2500))}catch(i){D(!1),A(i.message||"Terjadi kesalahan saat pendaftaran.")}}showNotFoundPage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}this._cleanupPreviousResources(),De(this._appContentElement)}}const R=document.getElementById("app-content");if(!R)throw console.error("Fatal Error: Elemen #app-content tidak ditemukan."),new Error("Elemen #app-content tidak ditemukan.");const S=new je(R);let b=null;async function oe(e){typeof b=="function"&&(b(),b=null),await e(),window.scrollTo({top:0,behavior:"instant"}),typeof window.updateNavigation=="function"?window.updateNavigation():console.warn("Fungsi window.updateNavigation tidak ditemukan. Navigasi mungkin tidak terupdate.")}const ae={"/":async()=>{if(!localStorage.getItem("userToken")){window.location.hash="#/login";return}await S.showHomePage(),b=null},"/add":async()=>{if(!localStorage.getItem("userToken")){window.location.hash="#/login";return}await S.showAddStoryPage(),b=()=>{typeof window.stopActiveCameraStreamGlobal=="function"&&window.stopActiveCameraStreamGlobal(),typeof window.destroyActiveLocationPickerMapGlobal=="function"&&window.destroyActiveLocationPickerMapGlobal()}},"/login":async()=>{if(localStorage.getItem("userToken")){window.location.hash="#/";return}await S.showLoginPage(),b=null},"/register":async()=>{if(localStorage.getItem("userToken")){window.location.hash="#/";return}await S.showRegisterPage(),b=null},"/404":async()=>{await S.showNotFoundPage(),b=null}};window.addEventListener("load",()=>{const e=window.location.hash.slice(1).toLowerCase()||"/",t=["/login","/register"];!localStorage.getItem("userToken")&&!t.includes(`/${e}`)?window.location.hash="#/login":localStorage.getItem("userToken")&&t.includes(`/${e}`)?window.location.hash="#/":Z()});async function Z(){const e=window.location.hash.slice(1).toLowerCase()||"/",t=ae[e]||ae["/404"]||(async()=>{console.warn(`Rute tidak ditemukan untuk path: ${e}. Menampilkan halaman 404 default.`),await S.showNotFoundPage(),b=null});try{document.startViewTransition?document.startViewTransition(()=>oe(t)):await oe(t)}catch(n){console.error(`Error saat navigasi ke path "${e}":`,n),R&&(!n||!n.message||!n.message.startsWith("Unauthorized:"))&&(R.innerHTML=`
            <div class="page-header"><h1>Oops! Terjadi Kesalahan Navigasi</h1></div>
            <div class="error-message">
                <p>Terjadi masalah saat mencoba menampilkan halaman ini.</p>
                <p><small>Detail error: ${n.message||"Error tidak diketahui"}</small></p>
            </div>
        `)}}window.addEventListener("hashchange",Z);window.addEventListener("load",()=>{const e=window.location.hash.slice(1).toLowerCase()||"/",t=["/login","/register"];!localStorage.getItem("userToken")&&!t.includes(`/${e}`)?window.location.hash="#/login":localStorage.getItem("userToken")&&t.includes(`/${e}`)?window.location.hash="#/":Z()});const Fe="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function Re(e){const t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(n),r=new Uint8Array(o.length);for(let a=0;a<o.length;++a)r[a]=o.charCodeAt(a);return r}async function Oe(){if(!("PushManager"in window)){console.error("Push Messaging tidak didukung oleh browser ini."),alert("Fitur notifikasi tidak didukung di browser ini.");return}try{if(await Notification.requestPermission()!=="granted"){console.warn("Izin notifikasi tidak diberikan."),alert("Anda tidak akan menerima notifikasi cerita baru jika izin tidak diberikan.");return}const t=await navigator.serviceWorker.ready;console.log("Melakukan subscribe ke Push Service...");const n=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Re(Fe)});console.log("Berhasil subscribe:",n),console.log("Mengirim subscription ke server..."),await Ne(n),alert("Anda berhasil subscribe untuk notifikasi cerita baru!")}catch(e){console.error("Gagal melakukan subscribe:",e),alert("Gagal subscribe untuk notifikasi. Silakan coba lagi.")}}const z=(e,t)=>t.some(n=>e instanceof n);let re,ie;function He(){return re||(re=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function qe(){return ie||(ie=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const W=new WeakMap,q=new WeakMap,H=new WeakMap;function Ve(e){const t=new Promise((n,o)=>{const r=()=>{e.removeEventListener("success",a),e.removeEventListener("error",i)},a=()=>{n(k(e.result)),r()},i=()=>{o(e.error),r()};e.addEventListener("success",a),e.addEventListener("error",i)});return H.set(t,e),t}function Ge(e){if(W.has(e))return;const t=new Promise((n,o)=>{const r=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",i),e.removeEventListener("abort",i)},a=()=>{n(),r()},i=()=>{o(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",i),e.addEventListener("abort",i)});W.set(e,t)}let K={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return W.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return k(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function de(e){K=e(K)}function Ue(e){return qe().includes(e)?function(...t){return e.apply(J(this),t),k(this.request)}:function(...t){return k(e.apply(J(this),t))}}function ze(e){return typeof e=="function"?Ue(e):(e instanceof IDBTransaction&&Ge(e),z(e,He())?new Proxy(e,K):e)}function k(e){if(e instanceof IDBRequest)return Ve(e);if(q.has(e))return q.get(e);const t=ze(e);return t!==e&&(q.set(e,t),H.set(t,e)),t}const J=e=>H.get(e);function We(e,t,{blocked:n,upgrade:o,blocking:r,terminated:a}={}){const i=indexedDB.open(e,t),l=k(i);return o&&i.addEventListener("upgradeneeded",s=>{o(k(i.result),s.oldVersion,s.newVersion,k(i.transaction),s)}),n&&i.addEventListener("blocked",s=>n(s.oldVersion,s.newVersion,s)),l.then(s=>{a&&s.addEventListener("close",()=>a()),r&&s.addEventListener("versionchange",c=>r(c.oldVersion,c.newVersion,c))}).catch(()=>{}),l}const Ke=["get","getKey","getAll","getAllKeys","count"],Je=["put","add","delete","clear"],V=new Map;function se(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(V.get(t))return V.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,r=Je.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(r||Ke.includes(n)))return;const a=async function(i,...l){const s=this.transaction(i,r?"readwrite":"readonly");let c=s.store;return o&&(c=c.index(l.shift())),(await Promise.all([c[n](...l),r&&s.done]))[0]};return V.set(t,a),a}de(e=>({...e,get:(t,n,o)=>se(t,n)||e.get(t,n,o),has:(t,n)=>!!se(t,n)||e.has(t,n)}));const Ye=["continue","continuePrimaryKey","advance"],le={},Y=new WeakMap,ue=new WeakMap,Qe={get(e,t){if(!Ye.includes(t))return e[t];let n=le[t];return n||(n=le[t]=function(...o){Y.set(this,ue.get(this)[t](...o))}),n}};async function*Ze(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,Qe);for(ue.set(n,t),H.set(n,J(t));t;)yield n,t=await(Y.get(n)||t.continue()),Y.delete(n)}function ce(e,t){return t===Symbol.asyncIterator&&z(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&z(e,[IDBIndex,IDBObjectStore])}de(e=>({...e,get(t,n,o){return ce(t,n)?Ze:e.get(t,n,o)},has(t,n){return ce(t,n)||e.has(t,n)}}));const Xe="story-app-database",et=1,_="stories",G=We(Xe,et,{upgrade(e){e.objectStoreNames.contains(_)||e.createObjectStore(_,{keyPath:"id"})}}),O={async getAllStories(){return console.log("DB: Mengambil semua cerita dari IndexedDB..."),(await G).getAll(_)},async putStory(e){if(!e||!e.id){console.error("DB: Data cerita atau ID tidak valid, tidak bisa disimpan.",e);return}return console.log("DB: Menyimpan cerita dengan ID:",e.id),(await G).put(_,e)},async deleteStory(e){if(!e){console.error("DB: ID tidak valid, tidak bisa menghapus.");return}return console.log("DB: Menghapus cerita dengan ID:",e),(await G).delete(_,e)}},me="userToken",pe="userName";function ge(){return localStorage.getItem(me)}async function he(){const e=ge();if(!e){console.log("Main.js: Pengguna belum login."),F([]);return}try{const t=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401){fe();return}const n=await t.json();if(n.error)throw new Error(n.message);console.log("Main.js: Data berhasil diambil dari API."),n.listStory.forEach(o=>{O.putStory(o)}),F(n.listStory)}catch(t){console.error("Main.js: Gagal fetch dari API, mencoba mengambil dari IndexedDB.",t);const n=await O.getAllStories();console.log("Main.js: Data dari IndexedDB akan ditampilkan."),F(n)}}function F(e=[]){const t=document.getElementById("story-list-container");if(t){if(t.innerHTML="",e.length===0){t.innerHTML="<p>Belum ada cerita untuk ditampilkan.</p>";return}e.forEach(n=>{const o=document.createElement("div");o.classList.add("card"),o.innerHTML=`
      <h3>${n.name}</h3>
      <img src="${n.photoUrl}" alt="Foto cerita dari ${n.name}" style="width:100%;">
      <p>${n.description}</p>
      <button class="button-delete" data-id="${n.id}">Hapus</button>
    `,t.appendChild(o)})}}async function tt(e){if(!e||!window.confirm("Apakah Anda yakin ingin menghapus cerita ini?"))return;await O.deleteStory(e),console.log(`Main.js: Cerita ${e} dihapus dari IndexedDB.`);const n=await O.getAllStories();F(n)}function X(){const e=document.getElementById("user-info"),t=ge(),n=localStorage.getItem(pe);if(!e){console.error("Main.js: Kritis! Elemen #user-info tidak ditemukan.");return}e.innerHTML="",t&&n?(e.innerHTML=`
      <p style="margin: 0 0 10px 0; font-weight: bold;">Halo, ${n}!</p>
      <button id="subscribe-button" class="button button--primary" style="width:100%; margin-bottom:8px;">Aktifkan Notifikasi</button>
      <button id="logout-button" class="button button--secondary" style="width:100%;">Logout</button>
    `,document.getElementById("subscribe-button").addEventListener("click",Oe),document.getElementById("logout-button").addEventListener("click",fe)):e.innerHTML=`
      <p style="margin:0;">
        <a href="#/login" class="auth-link">Login</a> atau <a href="#/register" class="auth-link">Register</a>
      </p>
    `}function fe(){console.log("Main.js: Pengguna logout."),localStorage.removeItem(me),localStorage.removeItem(pe),X(),window.location.hash="#/login"}function nt(){const e=document.querySelector(".skip-to-content-link"),t=document.getElementById("app-content");e&&t&&e.addEventListener("click",n=>{n.preventDefault(),t.focus()})}function ot(){const e="/sw.js";"serviceWorker"in navigator?window.addEventListener("load",()=>{navigator.serviceWorker.register(e,{type:"module"}).then(t=>{console.log("Service Worker berhasil didaftarkan sebagai module:",t.scope)}).catch(t=>{console.error("Pendaftaran Service Worker module gagal:",t)})}):console.log("Browser ini tidak mendukung Service Worker.")}function at(){document.body.addEventListener("click",e=>{if(e.target&&e.target.classList.contains("button-delete")){const t=e.target.dataset.id;tt(t)}})}function rt(){nt(),X(),ot(),he(),at()}window.addEventListener("DOMContentLoaded",rt);window.addEventListener("hashchange",()=>{X(),(window.location.hash===""||window.location.hash==="#/")&&he()});
