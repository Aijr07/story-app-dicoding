(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function a(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(r){if(r.ep)return;r.ep=!0;const n=a(r);fetch(r.href,n)}})();const h={};function xe(e,t,a,o){h[e]&&(h[e].remove(),delete h[e]);const r=document.getElementById(e);if(!r)return;r.style.display="block",r.style.height="300px";const n=L.map(e).setView([t,a],13);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(n),L.marker([t,a]).addTo(n).bindPopup(`<b>${o}</b>`).openPopup(),h[e]=n,setTimeout(()=>{h[e]&&h[e].invalidateSize()},100)}const Ce=e=>{const t=e.id,a=e.name||"Judul Tidak Tersedia",o=new Date(e.createdAt).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});let r="";if(e.lat&&e.lon){const n=`map-container-${t}`;r=`
      <div class="story-item__location-controls">
        <button class="button button--secondary view-map-button" 
                data-lat="${e.lat}" 
                data-lon="${e.lon}" 
                data-story-name="${a}" 
                data-map-target="${n}">
          Lihat Lokasi di Peta
        </button>
        <div id="${n}" class="story-item__map-container" style="display: none;"></div>
      </div>
    `}return`
    <article class="story-item" id="story-${t}">
      <img src="${e.photoUrl}" alt="Gambar dari ${a}" class="story-item__image" loading="lazy">
      <div class="story-item__content">
        <h3 class="story-item__title">${a}</h3>
        <p class="story-item__description">${e.description}</p>
        <p class="story-item__date">Dibuat pada: ${o}</p>
        ${r}
        <div class="story-item__actions">
          <button class="button button-save-offline" data-id="${t}">Simpan Offline</button>
          <button class="button button-delete-offline" data-id="${t}" style="display: none;">Hapus dari Offline</button>
        </div>
      </div>
    </article>
  `};function Ae(){document.querySelectorAll(".view-map-button").forEach(e=>{e.addEventListener("click",t=>{const a=t.currentTarget;document.querySelectorAll(".story-item__map-container").forEach(o=>{o.id!==a.dataset.mapTarget&&(o.style.display="none",h[o.id]&&h[o.id].remove())}),xe(a.dataset.mapTarget,parseFloat(a.dataset.lat),parseFloat(a.dataset.lon),a.dataset.storyName)})})}const D=(e,t)=>{e&&(e.innerHTML=`
    <div class="page-header">
      <h1>Daftar Cerita</h1>
      <p>Berikut adalah cerita-cerita yang telah dibagikan.</p>
    </div>
    <div id="story-list-container" class="story-list">
      ${t&&t.length>0?t.map(Ce).join(""):'<p class="no-stories">Belum ada cerita untuk ditampilkan.</p>'}
    </div>
  `,Ae())},pe=e=>{e&&(e.innerHTML='<div class="loading-indicator"><p>Memuat cerita...</p></div>')},z=(e,t)=>{e&&(e.innerHTML=`
    <div class="error-message">
      <h2>Oops! Terjadi Kesalahan</h2>
      <p>${t||"Gagal memuat data."}</p>
    </div>
  `)},W=(e,t)=>t.some(a=>e instanceof a);let ne,re;function Te(){return ne||(ne=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ie(){return re||(re=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const K=new WeakMap,V=new WeakMap,H=new WeakMap;function Be(e){const t=new Promise((a,o)=>{const r=()=>{e.removeEventListener("success",n),e.removeEventListener("error",i)},n=()=>{a(w(e.result)),r()},i=()=>{o(e.error),r()};e.addEventListener("success",n),e.addEventListener("error",i)});return H.set(t,e),t}function Me(e){if(K.has(e))return;const t=new Promise((a,o)=>{const r=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",i),e.removeEventListener("abort",i)},n=()=>{a(),r()},i=()=>{o(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",n),e.addEventListener("error",i),e.addEventListener("abort",i)});K.set(e,t)}let J={get(e,t,a){if(e instanceof IDBTransaction){if(t==="done")return K.get(e);if(t==="store")return a.objectStoreNames[1]?void 0:a.objectStore(a.objectStoreNames[0])}return w(e[t])},set(e,t,a){return e[t]=a,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function ge(e){J=e(J)}function _e(e){return Ie().includes(e)?function(...t){return e.apply(Y(this),t),w(this.request)}:function(...t){return w(e.apply(Y(this),t))}}function De(e){return typeof e=="function"?_e(e):(e instanceof IDBTransaction&&Me(e),W(e,Te())?new Proxy(e,J):e)}function w(e){if(e instanceof IDBRequest)return Be(e);if(V.has(e))return V.get(e);const t=De(e);return t!==e&&(V.set(e,t),H.set(t,e)),t}const Y=e=>H.get(e);function $e(e,t,{blocked:a,upgrade:o,blocking:r,terminated:n}={}){const i=indexedDB.open(e,t),s=w(i);return o&&i.addEventListener("upgradeneeded",l=>{o(w(i.result),l.oldVersion,l.newVersion,w(i.transaction),l)}),a&&i.addEventListener("blocked",l=>a(l.oldVersion,l.newVersion,l)),s.then(l=>{n&&l.addEventListener("close",()=>n()),r&&l.addEventListener("versionchange",c=>r(c.oldVersion,c.newVersion,c))}).catch(()=>{}),s}const Ne=["get","getKey","getAll","getAllKeys","count"],Oe=["put","add","delete","clear"],U=new Map;function ie(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(U.get(t))return U.get(t);const a=t.replace(/FromIndex$/,""),o=t!==a,r=Oe.includes(a);if(!(a in(o?IDBIndex:IDBObjectStore).prototype)||!(r||Ne.includes(a)))return;const n=async function(i,...s){const l=this.transaction(i,r?"readwrite":"readonly");let c=l.store;return o&&(c=c.index(s.shift())),(await Promise.all([c[a](...s),r&&l.done]))[0]};return U.set(t,n),n}ge(e=>({...e,get:(t,a,o)=>ie(t,a)||e.get(t,a,o),has:(t,a)=>!!ie(t,a)||e.has(t,a)}));const Fe=["continue","continuePrimaryKey","advance"],se={},Q=new WeakMap,fe=new WeakMap,Re={get(e,t){if(!Fe.includes(t))return e[t];let a=se[t];return a||(a=se[t]=function(...o){Q.set(this,fe.get(this)[t](...o))}),a}};async function*qe(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const a=new Proxy(t,Re);for(fe.set(a,t),H.set(a,Y(t));t;)yield a,t=await(Q.get(a)||t.continue()),Q.delete(a)}function le(e,t){return t===Symbol.asyncIterator&&W(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&W(e,[IDBIndex,IDBObjectStore])}ge(e=>({...e,get(t,a,o){return le(t,a)?qe:e.get(t,a,o)},has(t,a){return le(t,a)||e.has(t,a)}}));let x=null,S=null,p=null,$=null;const E=()=>{if(x){x.getTracks().forEach(t=>t.stop()),x=null;const e=document.getElementById("camera-video");e&&(e.srcObject=null),console.log("View: Camera stream stopped.")}};window.stopActiveCameraStreamGlobal=E;const Z=()=>{p&&(p.remove(),p=null,$=null,console.log("View: Location picker map destroyed."))};window.destroyActiveLocationPickerMapGlobal=Z;const je=e=>{E(),Z(),S=null,e.innerHTML=`
    <div class="page-header">
      <h1>Tambah Cerita Baru</h1>
      <p>Bagikan momen berharga Anda melalui cerita dan foto.</p>
    </div>
    <form id="add-story-form" class="add-story-form">
      <div class="form-group">
        <label for="story-description">Deskripsi Cerita:</label>
        <textarea id="story-description" name="description" rows="4" required></textarea>
      </div>

      <div class="form-group">
        <label>Foto Cerita:</label>
        <div id="camera-controls" style="margin-bottom: 10px;">
            <button type="button" id="use-camera-button" class="button button--secondary">Gunakan Kamera</button>
            <span style="margin: 0 10px;">atau</span>
            <label for="story-photo" class="button button--secondary" style="cursor:pointer; display:inline-block;">Pilih File</label>
            <input type="file" id="story-photo" name="photo" accept="image/*" style="display:none;">
        </div>

        <div id="camera-area" style="margin-bottom: 10px; display:none;">
          <video id="camera-video" playsinline autoplay style="width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 4px; background-color: #000;"></video>
          <canvas id="camera-canvas" style="display:none;"></canvas> <div style="margin-top:10px;">
              <button type="button" id="capture-photo-button" class="button button--primary">Ambil Foto</button>
              <button type="button" id="close-camera-button" class="button button--danger" style="margin-left:5px;">Tutup Kamera</button>
          </div>
        </div>
        
        <img id="image-preview" src="#" alt="Pratinjau gambar yang akan diunggah atau diambil" style="display: none; max-width: 100%; margin-top: 10px; max-height: 300px; border: 1px solid #ccc; border-radius: 4px;"/>
        <input type="hidden" id="photo-source" name="photoSource" value="file"> </div>

      <div class="form-group">
        <p><strong>Pengambilan Lokasi (Opsional):</strong></p>
        <button type="button" id="toggle-map-picker" class="button button--secondary">Ambil Lokasi dari Peta</button>
        <div id="map-picker-container" style="height: 350px; border: 1px solid var(--warna-border, #ccc); margin-top:10px; margin-bottom:10px; display:none; border-radius: 4px; position: relative; background-color: #e9e9e9;">
          </div>
        <label for="story-latitude" style="margin-top:5px; display:block;">Latitude:</label>
        <input type="text" id="story-latitude" name="latitude" placeholder="Contoh: -6.200000" readonly >
        <label for="story-longitude" style="margin-top:5px; display:block;">Longitude:</label>
        <input type="text" id="story-longitude" name="longitude" placeholder="Contoh: 106.816666" readonly >
      </div>
      
      <div class="form-actions">
        <button type="submit" id="submit-story-button" class="button button--primary">Publikasikan Cerita</button>
        <div id="loading-indicator-add" style="display: none; margin-right:10px; font-style:italic;">Mengirim cerita...</div>
        <div id="error-message-add" class="error-message-form" style="display: none;"></div>
      </div>
    </form>
  `;const t=e.querySelector("#story-photo"),a=e.querySelector("#image-preview"),o=e.querySelector("#photo-source"),r=e.querySelector("#camera-controls"),n=e.querySelector("#camera-area"),i=e.querySelector("#camera-video"),s=e.querySelector("#camera-canvas"),l=e.querySelector("#use-camera-button"),c=e.querySelector("#capture-photo-button"),F=e.querySelector("#close-camera-button"),k=e.querySelector("#toggle-map-picker"),d=e.querySelector("#map-picker-container"),u=e.querySelector("#story-latitude"),f=e.querySelector("#story-longitude"),A=m=>{a&&(a.src=m,a.style.display="block")};t&&t.addEventListener("change",()=>{console.log("View: File input changed."),E(),n&&(n.style.display="none"),r&&(r.style.display="block");const m=t.files[0];if(m){const g=new FileReader;g.onload=T=>A(T.target.result),g.readAsDataURL(m),o&&(o.value="file"),S=null}else a&&(a.src="#",a.style.display="none")}),l&&n&&i&&r&&o&&l.addEventListener("click",async()=>{console.log('View: "Gunakan Kamera" button clicked.'),E(),t&&(t.value=""),a&&(a.style.display="none"),S=null,n.style.display="block",r.style.display="none";try{x=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}),i.srcObject=x,o.value="camera",console.log("View: Camera stream started.")}catch(m){console.error("View: Error mengakses kamera: ",m),alert(`Tidak bisa mengakses kamera. Pastikan Anda memberikan izin dan kamera tersedia.
Error: `+m.message),n.style.display="none",r.style.display="block",o.value="file"}}),c&&i&&s&&a&&r&&o&&c.addEventListener("click",()=>{if(console.log('View: "Ambil Foto" button clicked.'),!x||!i.srcObject){alert("Kamera tidak aktif.");return}s.width=i.videoWidth,s.height=i.videoHeight,s.getContext("2d").drawImage(i,0,0,s.width,s.height);const g=s.toDataURL("image/jpeg",.9);A(g),s.toBlob(T=>{S=T,console.log("View: Photo captured as blob.")},"image/jpeg",.9),E(),n.style.display="none",r.style.display="block"}),F&&n&&r&&o&&a&&F.addEventListener("click",()=>{console.log('View: "Tutup Kamera" button clicked.'),E(),n.style.display="none",r.style.display="block",o.value==="camera"&&!S&&(o.value="file",a.style.display="none")});const R=()=>{if(p||!d)return;console.log("View: Initializing location picker map.");const m=-6.2088,g=106.8456,T=12;d.innerHTML="";try{p=L.map(d).setView([m,g],T),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(p);const I=L.DomUtil.create("div","map-info-overlay leaflet-control");I.innerHTML="Klik pada peta untuk memilih lokasi.",I.style.cssText="background: white; padding: 6px 10px; margin:10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; box-shadow: 0 1px 5px rgba(0,0,0,0.4);";const Se=L.Control.extend({onAdd:function(v){return I},onRemove:function(v){}});new Se({position:"topleft"}).addTo(p),p.on("click",v=>{const{lat:Ee,lng:Pe}=v.latlng;u&&(u.value=Ee.toFixed(6)),f&&(f.value=Pe.toFixed(6)),$?$.setLatLng(v.latlng):($=L.marker(v.latlng,{draggable:!0}).addTo(p),$.on("dragend",Le=>{const oe=Le.target.getLatLng();u&&(u.value=oe.lat.toFixed(6)),f&&(f.value=oe.lng.toFixed(6))})),p.panTo(v.latlng)}),setTimeout(()=>{p&&p.invalidateSize()},100)}catch(I){console.error("View: Error initializing Leaflet map:",I),d.innerHTML="<p style='text-align:center; padding-top:20px; color:red;'>Gagal memuat peta. Pastikan Leaflet termuat dengan benar.</p>"}};k&&d&&k.addEventListener("click",()=>{console.log('View: "Toggle Map Picker" button clicked.'),d.style.display==="none"?(d.style.display="block",k.textContent="Sembunyikan Peta Lokasi",R()):(d.style.display="none",k.textContent="Ambil Lokasi dari Peta",Z())}),e&&(e.getCapturedPhotoBlob=()=>S,e.getPhotoSource=()=>o?o.value:"file")},B=e=>{const t=document.getElementById("loading-indicator-add"),a=document.getElementById("submit-story-button");t&&a&&(t.style.display=e?"inline-block":"none",a.disabled=e)},q=e=>{const t=document.getElementById("error-message-add");t&&(t.textContent=e,t.style.display=e?"block":"none")},Ge=e=>{e.innerHTML=`
      <div class="page-header" style="text-align: center;">
        <h1>Login ke Aplikasi Cerita</h1>
      </div>
      <div class="login-container" style="max-width: 400px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px;">
        <form id="login-form">
          <div class="form-group">
            <label for="login-email">Email:</label>
            <input type="email" id="login-email" name="email" required>
          </div>
          <div class="form-group">
            <label for="login-password">Password:</label>
            <input type="password" id="login-password" name="password" required autocomplete="current-password">
          </div>
          <div class="form-actions" style="text-align: center;">
            <button type="submit" id="login-button" class="button button--primary">Login</button>
            <div id="login-loading-indicator" style="display: none; margin-top:10px; font-style:italic;">Memproses login...</div>
            <div id="login-error-message" class="error-message-form" style="display: none; margin-top:10px;"></div>
          </div>
        </form>
        <p style="text-align:center; margin-top:15px;">Belum punya akun? <a href="#/register">Daftar di sini</a>.</p> 
        </div>
    `},He=e=>{},ce=e=>{},Ve=e=>{e.innerHTML=`
      <div class="page-header" style="text-align: center;">
        <h1>Buat Akun Baru</h1>
        <p>Daftarkan diri Anda untuk mulai berbagi cerita.</p>
      </div>
      <div class="register-container" style="max-width: 400px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px;">
        <form id="register-form">
          <div class="form-group">
            <label for="register-name">Nama Lengkap:</label>
            <input type="text" id="register-name" name="name" required>
          </div>
          <div class="form-group">
            <label for="register-email">Email:</label>
            <input type="email" id="register-email" name="email" required>
          </div>
          <div class="form-group">
            <label for="register-password">Password:</label>
            <input type="password" id="register-password" name="password" minlength="8" required>
            <small>Minimal 8 karakter.</small>
          </div>
          <div class="form-actions" style="text-align: center;">
            <button type="submit" id="register-button" class="button button--primary">Daftar</button>
            <div id="register-loading-indicator" style="display: none; margin-top:10px; font-style:italic;">Memproses pendaftaran...</div>
            <div id="register-error-message" class="error-message-form" style="display: none; margin-top:10px;"></div>
            <div id="register-success-message" style="display: none; margin-top:10px; color: green;"></div>
          </div>
        </form>
        <p style="text-align:center; margin-top:15px;">Sudah punya akun? <a href="#/login">Login di sini</a>.</p>
      </div>
    `},M=e=>{const t=document.getElementById("register-loading-indicator"),a=document.getElementById("register-button");t&&a&&(t.style.display=e?"block":"none",a.disabled=e)},_=e=>{const t=document.getElementById("register-error-message"),a=document.getElementById("register-success-message");t&&(t.textContent=e,t.style.display=e?"block":"none"),a&&(a.style.display="none")},de=e=>{const t=document.getElementById("register-success-message"),a=document.getElementById("register-error-message");t&&(t.textContent=e,t.style.display=e?"block":"none"),a&&(a.style.display="none")},Ue=e=>{e.innerHTML=`
      <h1>404 - Halaman Tidak Ditemukan</h1>
      <p>Maaf, halaman yang Anda cari tidak tersedia.</p>
    `},O="https://story-api.dicoding.dev/v1";async function X(e,t={}){const a=localStorage.getItem("userToken"),o={};t.body instanceof FormData||(o["Content-Type"]="application/json"),a&&(o.Authorization=`Bearer ${a}`);const r={...t,headers:{...o,...t.headers}};try{const n=await fetch(e,r);if(!n.ok){if(n.status===401||n.status===403)throw console.error("Authentication error:",n.status),localStorage.removeItem("userToken"),localStorage.removeItem("userName"),window.location.hash="#/login",new Error(`Unauthorized: ${n.statusText}. Redirecting to login.`);const i=await n.json().catch(()=>({message:n.statusText}));throw new Error(`HTTP error! status: ${n.status}, message: ${i.message||"Failed to fetch"}`)}return n.status===204?null:n.json()}catch(n){if(n.message.startsWith("Unauthorized:"))return console.warn(n.message),Promise.reject(n);throw console.error("Network/Fetch error in fetchWithAuth:",n),n}}async function ze(e,t,a){try{const o=await fetch(`${O}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:a})}),r=await o.json();if(!o.ok||r.error)throw new Error(r.message||`HTTP error! status: ${o.status}`);return r}catch(o){throw console.error("Error registering user:",o),o}}async function We(e,t){try{const a=await fetch(`${O}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),o=await a.json();if(!a.ok||o.error)throw new Error(o.message||`HTTP error! status: ${a.status}`);return o}catch(a){throw console.error("Error logging in user:",a),a}}async function Ke(e=1,t=10,a=!1){let o=`${O}/stories?page=${e}&size=${t}`;a&&(o+="&location=1");const r=await X(o);if(r&&!r.error)return r.listStory||[];if(r)throw new Error(r.message||"Failed to get stories");return[]}async function Je(e,t,a,o){const r=new FormData;r.append("description",e),r.append("photo",t),a!=null&&a!==""&&r.append("lat",parseFloat(a)),o!=null&&o!==""&&r.append("lon",parseFloat(o));const n=await X(`${O}/stories`,{method:"POST",body:r});if(n&&!n.error)return n;throw n?new Error(n.message||"Gagal menambahkan cerita baru."):new Error("Gagal menambahkan cerita karena masalah otentikasi atau jaringan.")}async function Ye(e){const t=e.toJSON(),a={endpoint:t.endpoint,keys:{p256dh:t.keys.p256dh,auth:t.keys.auth}};try{const o=await X(`${O}/notifications/subscribe`,{method:"POST",body:JSON.stringify(a)});return console.log("Respons dari server setelah subscribe notifikasi:",o),o}catch(o){throw console.error("Gagal mengirim subscription ke server:",o),o}}class Qe{constructor(t){this._appContentElement=t,this._handleAddNewStory=this._handleAddNewStory.bind(this),this._handleLogin=this._handleLogin.bind(this),this._handleRegister=this._handleRegister.bind(this)}_cleanupPreviousResources(){typeof window.stopActiveCameraStreamGlobal=="function"&&(console.log("PagePresenter: Cleaning up camera stream."),window.stopActiveCameraStreamGlobal()),typeof window.destroyActiveLocationPickerMapGlobal=="function"&&(console.log("PagePresenter: Cleaning up location picker map."),window.destroyActiveLocationPickerMapGlobal())}async showHomePage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}this._cleanupPreviousResources(),pe(this._appContentElement);try{if(!localStorage.getItem("userToken")){console.warn("PagePresenter (showHomePage): No user token found, should be redirected by router."),window.location.hash="#/login";return}const t=await Ke();D(this._appContentElement,t)}catch(t){t&&t.message&&!t.message.startsWith("Unauthorized:")&&(console.error("PagePresenter: Gagal menampilkan halaman beranda:",t),z(this._appContentElement,t.message||"Gagal memuat cerita."))}}showAddStoryPage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}if(!localStorage.getItem("userToken")){console.warn("PagePresenter (showAddStoryPage): No user token found, should be redirected by router."),window.location.hash="#/login";return}this._cleanupPreviousResources(),je(this._appContentElement);const t=this._appContentElement.querySelector("#add-story-form");t?(t.removeEventListener("submit",this._handleAddNewStory),t.addEventListener("submit",this._handleAddNewStory)):console.error("PagePresenter: Form #add-story-form tidak ditemukan setelah render.")}async _handleAddNewStory(t){t.preventDefault(),B(!0),q("");const a=t.target,o=a.elements.description,r=a.elements.photo,n=this._appContentElement.getPhotoSource?this._appContentElement.getPhotoSource():"file",i=this._appContentElement.getCapturedPhotoBlob?this._appContentElement.getCapturedPhotoBlob():null,s=a.elements.latitude,l=a.elements.longitude;if(!o){q("Kesalahan formulir: field deskripsi tidak ditemukan."),B(!1);return}const c=o.value.trim(),F=s?s.value.trim():"",k=l?l.value.trim():"";let d=null;if(n==="camera"&&i){const u=`camera-shot-${Date.now()}.jpg`;d=new File([i],u,{type:i.type||"image/jpeg"})}else r&&r.files&&r.files[0]&&(d=r.files[0]);if(!c||!d){q("Deskripsi dan foto wajib diisi."),B(!1);return}try{const u=await Je(c,d,F||void 0,k||void 0);B(!1),alert(`Cerita berhasil ditambahkan! Pesan: ${u.message}`),a.reset();const f=a.querySelector("#image-preview");f&&(f.style.display="none",f.src="#"),document.getElementById("story-latitude")&&(document.getElementById("story-latitude").value=""),document.getElementById("story-longitude")&&(document.getElementById("story-longitude").value="");const A=a.querySelector("#camera-area");A&&(A.style.display="none");const R=a.querySelector("#camera-controls");R&&(R.style.display="block");const m=a.querySelector("#map-picker-container");m&&(m.style.display="none");const g=a.querySelector("#toggle-map-picker");g&&(g.textContent="Ambil Lokasi dari Peta"),this._cleanupPreviousResources(),window.location.hash="#/"}catch(u){B(!1),u&&u.message&&!u.message.startsWith("Unauthorized:")&&q(u.message||"Gagal menambahkan cerita.")}}showLoginPage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}this._cleanupPreviousResources(),Ge(this._appContentElement);const t=this._appContentElement.querySelector("#login-form");t?(t.removeEventListener("submit",this._handleLogin),t.addEventListener("submit",this._handleLogin)):console.error("PagePresenter: Form #login-form tidak ditemukan setelah render.")}async _handleLogin(t){t.preventDefault();const a=t.target,o=a.elements.email.value.trim(),r=a.elements.password.value;if(!(!o||!r))try{const n=await We(o,r);He(!1),!n.error&&n.loginResult&&n.loginResult.token?(localStorage.setItem("userToken",n.loginResult.token),localStorage.setItem("userName",n.loginResult.name),alert("Login berhasil!"),window.location.hash="#/"):ce(n.message||"Login gagal. Periksa kredensial Anda.")}catch(n){ce(n.message||"Terjadi kesalahan saat login.")}}showRegisterPage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}this._cleanupPreviousResources(),Ve(this._appContentElement);const t=this._appContentElement.querySelector("#register-form");t?(t.removeEventListener("submit",this._handleRegister),t.addEventListener("submit",this._handleRegister)):console.error("PagePresenter: Form #register-form tidak ditemukan setelah render.")}async _handleRegister(t){t.preventDefault(),M(!0),_(""),de("");const a=t.target,o=a.elements.name.value.trim(),r=a.elements.email.value.trim(),n=a.elements.password.value;if(!o||!r||!n){_("Semua field wajib diisi."),M(!1);return}if(n.length<8){_("Password minimal 8 karakter."),M(!1);return}try{const i=await ze(o,r,n);M(!1),i.error?_(i.message||"Pendaftaran gagal."):(de(i.message+" Silakan login."),a.reset(),setTimeout(()=>{window.location.hash==="#/register"&&!localStorage.getItem("userToken")&&(window.location.hash="#/login")},2500))}catch(i){M(!1),_(i.message||"Terjadi kesalahan saat pendaftaran.")}}showNotFoundPage(){if(!this._appContentElement){console.error("PagePresenter: Elemen konten aplikasi (#app-content) tidak ditemukan.");return}this._cleanupPreviousResources(),Ue(this._appContentElement)}}const ee=document.getElementById("app-content");if(!ee)throw new Error("Fatal Error: Elemen #app-content tidak ditemukan.");const j=new Qe(ee);let b=null;async function ue(e){typeof b=="function"&&(b(),b=null),await e(),window.scrollTo({top:0,behavior:"instant"})}const me={"/":()=>{},"/add":async()=>{if(!localStorage.getItem("userToken")){window.location.hash="#/login";return}await j.showAddStoryPage(),b=()=>{typeof window.stopActiveCameraStreamGlobal=="function"&&window.stopActiveCameraStreamGlobal(),typeof window.destroyActiveLocationPickerMapGlobal=="function"&&window.destroyActiveLocationPickerMapGlobal()}},"/login":async()=>{if(localStorage.getItem("userToken")){window.location.hash="#/";return}await j.showLoginPage(),b=null},"/register":async()=>{if(localStorage.getItem("userToken")){window.location.hash="#/";return}await j.showRegisterPage(),b=null},"/404":async()=>{await j.showNotFoundPage(),b=null}};async function ye(){typeof window.updateNavigation=="function"&&window.updateNavigation();const e=window.location.hash.slice(1).toLowerCase()||"/",t=me[e]||me["/404"];if(e!=="/")try{document.startViewTransition?document.startViewTransition(()=>ue(t)):await ue(t)}catch(a){console.error(`Error saat navigasi ke path "${e}":`,a),ee.innerHTML='<div class="error-message"><p>Gagal menampilkan halaman.</p></div>'}}window.addEventListener("hashchange",ye);window.addEventListener("load",ye);const Ze="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function Xe(e){const t="=".repeat((4-e.length%4)%4),a=(e+t).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(a),r=new Uint8Array(o.length);for(let n=0;n<o.length;++n)r[n]=o.charCodeAt(n);return r}async function et(){if(!("PushManager"in window)){console.error("Push Messaging tidak didukung oleh browser ini."),alert("Fitur notifikasi tidak didukung di browser ini.");return}try{if(await Notification.requestPermission()!=="granted"){console.warn("Izin notifikasi tidak diberikan."),alert("Anda tidak akan menerima notifikasi cerita baru jika izin tidak diberikan.");return}const t=await navigator.serviceWorker.ready;console.log("Melakukan subscribe ke Push Service...");const a=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Xe(Ze)});console.log("Berhasil subscribe:",a),console.log("Mengirim subscription ke server..."),await Ye(a),alert("Anda berhasil subscribe untuk notifikasi cerita baru!")}catch(e){console.error("Gagal melakukan subscribe:",e),alert("Gagal subscribe untuk notifikasi. Silakan coba lagi.")}}const he="userToken",be="userName",we="story-images-cache-v1",y=document.querySelector("#app-content"),tt="story-app-database",at=1,P="stories",N=$e(tt,at,{upgrade(e){e.objectStoreNames.contains(P)||e.createObjectStore(P,{keyPath:"id"})}}),C={async getAllStories(){return(await N).getAll(P)},async putStory(e){if(!(!e||!e.id))return(await N).put(P,e)},async getStory(e){if(e)return(await N).get(P,e)},async deleteStory(e){if(e)return(await N).delete(P,e)}};function te(){return localStorage.getItem(he)}function ae(){var o,r;const e=document.getElementById("user-info");if(!e)return;const t=te(),a=localStorage.getItem(be);e.innerHTML="",t&&a?(e.innerHTML=`
      <p style="font-weight: bold;">Halo, ${a}!</p>
      <button id="subscribe-button" class="button button--primary">Aktifkan Notifikasi</button>
      <button id="logout-button" class="button button--secondary">Logout</button>
    `,(o=document.getElementById("subscribe-button"))==null||o.addEventListener("click",et),(r=document.getElementById("logout-button"))==null||r.addEventListener("click",ke)):e.innerHTML='<p><a href="#/login" class="auth-link">Login</a> atau <a href="#/register" class="auth-link">Register</a></p>'}function ke(){localStorage.removeItem(he),localStorage.removeItem(be),ae(),window.location.hash="#/login"}async function ve(){if(!y)return;pe(y);const e=te();if(!e){D(y,[]),await G();return}if(navigator.onLine){console.log("Status: ONLINE. Mengambil semua cerita dari API...");try{const a=await fetch("https://story-api.dicoding.dev/v1/stories",{headers:{Authorization:`Bearer ${e}`}});if(a.status===401)return console.warn("Token tidak valid atau kadaluarsa. Melakukan logout."),ke();if(!a.ok)throw new Error(`HTTP error ${a.status}`);const o=await a.json();if(o.error)throw new Error(o.message);D(y,o.listStory)}catch(a){console.error("Gagal fetch dari API meski online, fallback ke IndexedDB:",a);const o=await C.getAllStories();o&&o.length>0?D(y,o):z(y,"Gagal mengambil cerita dari API dan tidak ada cerita tersimpan.")}}else{console.log("Status: OFFLINE. Mengambil cerita yang tersimpan dari IndexedDB.");const a=await C.getAllStories();a&&a.length>0?D(y,a):z(y,"Anda sedang offline dan belum ada cerita yang tersimpan.")}await G()}async function ot(e){if(!e)return;if(!navigator.onLine){alert("Anda harus online untuk dapat menyimpan cerita.");return}const t=te();if(!t){alert("Anda harus login untuk menyimpan cerita.");return}const a=document.querySelector(`.button-save-offline[data-id="${e}"]`);a&&(a.textContent="Menyimpan...",a.disabled=!0);try{const r=await(await fetch(`https://story-api.dicoding.dev/v1/stories/${e}`,{headers:{Authorization:`Bearer ${t}`}})).json();if(r.error)throw new Error(r.message);const n=r.story;if(await C.putStory(n),console.log(`Data cerita ${e} berhasil disimpan ke IndexedDB.`),n.photoUrl){const i=await caches.open(we);try{await i.add(n.photoUrl),console.log(`Gambar untuk cerita ${e} berhasil disimpan ke cache.`)}catch(s){console.warn(`Gagal menyimpan gambar ${n.photoUrl} ke cache:`,s)}}alert("Cerita berhasil disimpan untuk offline!")}catch(o){console.error(`Gagal menyimpan cerita ${e}:`,o),alert("Gagal menyimpan cerita. Proses dibatalkan. Cek konsol untuk detail.")}finally{await G()}}async function nt(e){if(e&&confirm("Hapus cerita ini dari daftar offline?"))try{const t=await C.getStory(e);await C.deleteStory(e),console.log(`Cerita ${e} dihapus dari IndexedDB.`),t&&t.photoUrl&&(await(await caches.open(we)).delete(t.photoUrl),console.log(`Gambar untuk cerita ${e} berhasil dihapus dari cache.`)),alert("Cerita berhasil dihapus dari daftar offline.")}catch(t){console.error(`Gagal menghapus cerita ${e}:`,t),alert("Gagal menghapus cerita.")}finally{await G()}}async function G(){console.log("Memperbarui status semua tombol...");const e=document.querySelectorAll(".story-item");if(e.length===0){console.warn("Tidak ada elemen .story-item ditemukan untuk memperbarui tombol.");return}for(const t of e){const a=t.querySelector(".button-save-offline"),o=t.querySelector(".button-delete-offline");if(!a||!o){console.warn("Lewati item cerita: Tombol save/delete offline tidak ditemukan di dalamnya.",t);continue}const r=a.dataset.id;if(!r){console.warn("Lewati item cerita: Story ID tidak ditemukan pada tombol save/delete.",t);continue}try{await C.getStory(r)?(a.style.display="none",o.style.display="inline-block"):(a.style.display="inline-block",a.textContent="Simpan Offline",a.disabled=!1,o.style.display="none")}catch(n){console.error("Error saat memeriksa status cerita di IndexedDB untuk ID:",r,n),a.style.display="inline-block",a.textContent="Simpan Offline",a.disabled=!1,o.style.display="none"}}console.log("Status tombol selesai diperbarui.")}function rt(){document.body.addEventListener("click",e=>{const t=e.target;t.matches(".button-save-offline")?ot(t.dataset.id):t.matches(".button-delete-offline")&&nt(t.dataset.id)})}function it(){"serviceWorker"in navigator?navigator.serviceWorker.register("/sw.js",{scope:"/",type:"module"}).then(e=>console.log("SW terdaftar:",e.scope),e=>console.error("Pendaftaran SW gagal:",e)):console.warn("Service Workers tidak didukung di browser ini.")}async function st(){await N,console.log("IndexedDB siap."),ae(),it(),await ve(),rt()}window.addEventListener("DOMContentLoaded",st);window.addEventListener("hashchange",async()=>{ae(),(window.location.hash===""||window.location.hash==="#/")&&await ve()});
